<html>
  <head>
    <title>Canvas Prompter</title>

    <link rel="stylesheet" href="../node_modules/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="app.css">
  </head>
  <body>
    <script type="text/javascript" src="../node_modules/jquery/jquery.js"></script>
    <script type="text/javascript">var jQuery = window.$;</script>
    <script type="text/javascript" src="canvasprompter.js"></script>

    <!-- key map defs -->
    <script type="text/javascript" src="keymap.js"></script>
    
    <!--  angular stuffs-->
    <script type="text/javascript" src="../node_modules/angular/angular.js"></script>
    <script type="text/javascript" src="../node_modules/angular-animate/angular-animate.js"></script>
    <script type="text/javascript" src="control.js"></script>

    <!-- bootstrap -->
    
    <script type="text/javascript" src="../node_modules/bootstrap/dist/js/bootstrap.js"></script>

    <!--  actual stuff-->
    <script type="text/javascript">
      //what do we need on the renderer?
      const ipc = require('electron').ipcRenderer
      const fs = require('fs')

    	//now, create the prompter
    	var prompter = new Prompter();

      //set it to window size
      prompter.maximize();

      //make sure it stays the right size.
      window.addEventListener('resize', function(e){
        prompter.maximize();
      });

      //menu setup
      const {remote} = require('electron');
      const {Menu, MenuItem} = remote

      const menu = new Menu()
      menu.append(new MenuItem({label: 'Load Script', click() { prompter.controls.getScript() }}))

      menu.append(new MenuItem({type: 'separator'}))

      menu.append(new MenuItem({label: 'Jump to Start', click() { prompter.controls.scriptHome() }}))
      menu.append(new MenuItem({label: 'Jump to End', click() { prompter.controls.scriptEnd() }}))

      menu.append(new MenuItem({type: 'separator'}))
      var caretMenuItem = new MenuItem({
        label: 'Show Caret', type: 'checkbox', checked: true,
        click (e){
          e.checked = prompter.controls.toggleCaret();
        }})
      menu.append(caretMenuItem)

      var readlineMenuItem = new MenuItem({
        label: 'Show Readline', type: 'checkbox', checked: false,
        click (e){
          e.checked = prompter.controls.toggleReadline();
        }})
      menu.append(readlineMenuItem)

      var percentMenuItem = new MenuItem({
        label: 'Show Percent', type: 'checkbox', checked: true,
        click (e){
          e.checked = prompter.controls.togglePercent();
        }});
      menu.append(percentMenuItem)
      
      var progressMenuItem = new MenuItem({
        label: 'Show Progress', type: 'checkbox', checked: true,
        click (e){
          e.checked = prompter.controls.toggleProgress();
        }})
      menu.append(progressMenuItem)

      var settingsMenuItem = new MenuItem({
        label: 'Show Settings', type: 'checkbox',
        click (e){
          window.dispatchEvent(new Event('settings-toggle'));
        }})

      window.addEventListener('settings-toggle', function(event){
          setTimeout(function(){
          settingsMenuItem.checked = window.settingsVisible;
        }, 100);
        });
      menu.append(settingsMenuItem)

      menu.append(new MenuItem({type: 'separator'}))

      menu.append(new MenuItem({label: 'Exit', click() { prompter.controls.getScript() }}))


      window.addEventListener('contextmenu', (e) => {
        e.preventDefault()
        menu.popup(remote.getCurrentWindow())
      }, false)

      //controls`
      window.addEventListener('wheel', function(event){
        // console.log(event.deltaY)
        if(!event){return false;}
        event.preventDefault();
        if(event.deltaY < 0){
          prompter.controls.decreaseSpeed()
        }
        else if (event.deltaY > 0) {
          prompter.controls.increaseSpeed()
        }
      });

      //handle open script request
      prompter.onScriptOpen(function(){
        ipc.send('open-file-dialog');
      });

      //what to do if we get a new script?
      ipc.on('selected-file', function(event, filepath){
        fs.readFile(filepath[0], 'utf-8', function (err, data) {
          if(err){
              alert("An error ocurred reading the file :" + err.message);
              return;
          }
          // Change how to handle the file content
          prompter.setScript(data);
        });
      });

      prompter.init();
    </script>
    <div ng-app="prompter">
      <div ng-controller="SettingsController" class="animate-slide" ng-show="visible">
<!-- tabs -->
        <ul class="nav nav-tabs" role="tablist">
          <li role="presentation" class="active">
            <a href="#keys" role="tab" data-toggle="tab">Keys</a>
          </li>
          <li role="presentation">
            <a href="#values" role="tab" data-toggle="tab">Values</a>
          </li>
          <li role="presentation">
            <a href="#appeareance" role="tab" data-toggle="tab">Appeance</a>
          </li>
        </ul>
<!-- tab contents -->
        <div class="tab-content">
          <div role="tabpanel" class="tab-pane fade in active" id="keys">
            <key-table keys="keys"></key-table>
          </div>

          <div role="tabpanel" class="tab-pane fade" id="values">
            <table class="table table-striped">
              <tr>
                <th>Setting</th>
                <th>Value</th>
                <th></th>
              </tr>
              <tr key-settings ng-repeat="(setting, value) in settings">
                <!--<td>{{ key.code }}</td>-->
                <td>{{ setting }}</td>
                <td>
                  <input type="text" class="form-control" ng-model="settings[setting] "value="{{ value }}">
                </td>
                <td><button class="button" ng-click="updateSetting(setting, value)">update</button></td>
              </tr>
            </table>
          </div>

          <div role="tabpanel" class="tab-pane fade" id="appearance">app</div>

        </div>

      </div>
    </div>
  </body>

</html>
